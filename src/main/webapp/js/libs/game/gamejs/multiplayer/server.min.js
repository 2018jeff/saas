var express=require("express");var app=express.createServer();var client_dir=process.cwd();app.configure(function(){app.use(express.bodyParser());app.use(express.logger({format:":url :method"}));app.use(express.errorHandler({dumpExceptions:true,showStack:true}))});app.get("/multiplayer.js",function(b,a){a.sendfile(__dirname+"/multiplayer.js")});app.get("/test",function(b,a){a.sendfile(__dirname+"/test.html")});this.app=app;var lastID=1;var clients=this.clients={};var server=this;this.get_friends=function(a){return clients};this.log=function(a){console.log(a)};this.pre_process=function(a){return a};function log_num_clients(){var a=0;for(x in clients){a++}server.log(a+" clients connected")}function Client(e){var a=[];var c=null;var d=0;var b=null;this.state=null;this.old_friends=[];this.push=function(h,g,f){if(g){h.id=g}a.push(h);if(!f){this.try_send()}};this.close=function(){this.push("");server.log(" -> Poller closed: "+e)};this.kill=function(){for(var f in this.get_friends()){clients[f].push({type:"client_disconnected"},e)}if(c){c.res.end("")}server.log(" -> Dead: "+e);delete clients[e];log_num_clients()};this.get_friends=function(j){var h=server.get_friends(this);var g={};for(var i in this.old_friends){if(!(i in h)){this.push({type:"client_left"},i,true);g[i]=this.old_friends[i]}}for(var i in h){if(!(i in this.old_friends)){var f=h[i].state;if(f!=null){this.push({type:"client_state",state:f},i,true);g[i]=h[i]}}}this.old_friends=h;for(var i in g){if(i!=j){g[i].get_friends(e)}}this.try_send();return h};this.set_poller=function(h,g){if(d==0){for(var i in this.get_friends()){var f=clients[i].state;if(f!=null){this.push({type:"client_state",state:f},i,true)}}}if(c){this.close()}c={req:h,res:g};this.try_send();d=this.touch()};this.try_send=function(){if(a.length&&c){c.res.send(JSON.stringify(a));this.forget_poller();a=[]}};this.forget_poller=function(){c=null;var f=this;if(!b){b=setTimeout(function(){f.kill()},5000)}};this.touch=function(){if(b){clearTimeout(b);b=null}return this.last=new Date().getTime()};this.touch();this.has_poll_expired=function(){return c&&((new Date().getTime()-10000)>d)};this.is_dead=function(){return(new Date().getTime()-30000)>this.last};this.set_state=function(f){this.state=f;for(var g in this.get_friends()){clients[g].push({type:"client_state",state:this.state},e)}this.touch()}}app.get("/c/id",function(b,a){var c=lastID+++Math.random();clients[c]=new Client(c);a.end(JSON.stringify(c));server.log(" -> New client: "+c);log_num_clients()});app.get("/c/poll/:id",function(b,a){var e=clients[b.params.id];if(e){e.set_poller(b,a);var d=function(){e.forget_poller();server.log(" -> Poller closed: "+b.params.id)};b.on("close",d);b.on("end",d);server.log(" -> Poller started: "+b.params.id)}else{server.log(" -> Invalid client: "+b.params.id);a.end("false",404);log_num_clients()}});app.post("/c/broadcast/:id",function(e,d){var b=clients[e.params.id];if(b){b.touch();for(var f in b.get_friends()){if(f!=e.params.id){var a=JSON.parse(e.body.p);a.type="broadcast";clients[f].push(a,e.params.id);server.log(" -> "+e.params.id+" -> "+f+": "+a)}}d.end("true")}else{d.end("false")}});app.post("/c/state/:id",function(c,b){var a=clients[c.params.id];if(a){a.touch();a.set_state(JSON.parse(c.body.p));server.log(" -> "+c.params.id+" STATE");b.end("true")}else{b.end("false")}});function start_checks(){setInterval(function(){for(var a in clients){if(clients[a].has_poll_expired()){server.log(" -> Poll reset: "+a);clients[a].close()}}},1000);setInterval(function(){for(var a in clients){if(clients[a].is_dead()){clients[a].kill()}}},1000)}this.start=function(){start_checks();app.listen(8000);server.log("listening on port 8000");server.log("serving: "+client_dir)};if(!module.parent){this.start()};