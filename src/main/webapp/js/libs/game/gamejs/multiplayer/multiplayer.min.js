if(typeof(JSON)=="undefined"||typeof(JSON.stringify)=="undefined"||typeof(JSON.parse)=="undefined"){alert("JSON.stringify() not found. Try https://raw.github.com/douglascrockford/JSON-js/master/json2.js")}var isIE=navigator.userAgent.indexOf("MSIE")!=-1;var multiplayer={connect:function(b){var a=new this.MultiplayerClient();a.connect(b);return a}};multiplayer.MultiplayerClient=function(){var a=null;var d=null;var c=this;var b={};this.connect=function(e){a=e||document.location.href.split("/").slice(0,-1).join("/")+"/c";var f=this;multiplayer.makeRequest(a+"/id",function(g){d=g;f.call("connected");f.poll()},function(){f.timeout()});return this};this.disconnected=function(){a=null;d=null;this.call("disconnected")};this.timeout=function(){a=null;d=null;this.call("timeout")};this.get_id=function(){return d};this.on=function(e,f){b[e]=f};this.broadcast=function(e,h,i,g){if(d&&a){var f=this;multiplayer.makeRequest(a+"/broadcast/"+d,function(j){if(j=="true"){if(i){i()}}else{if(g){g(j)}f.disconnected()}},function(){f.timeout()},"POST","p="+JSON.stringify({tag:e,payload:h}))}else{this.disconnected()}};this.set_state=function(g,h,f){if(d&&a){var e=this;multiplayer.makeRequest(a+"/state/"+d,function(i){if(i=="true"){if(h){h()}}else{if(f){f(i)}e.disconnected()}},function(){e.timeout()},"POST","p="+JSON.stringify(g))}else{this.disconnected()}};this.call=function(f,e){if(typeof(b[f])!="undefined"){b[f](e)}};this.poll=function(){if(d&&a){var e=this;multiplayer.makeRequest(a+"/poll/"+d,function(g){if(g=="false"){e.disconnected()}else{var f=JSON.parse(g);if(f){for(var h=0;h<f.length;h++){if(f[h]&&f[h].id!=d){if(f[h].type=="broadcast"){e.call(f[h].tag,{id:f[h].id,payload:f[h].payload})}else{if(f[h].type=="client_state"){e.call("client_state",f[h])}else{if(f[h].type=="client_disconnected"){e.call("client_disconnected",f[h].id)}else{if(f[h].type=="client_left"){e.call("client_left",f[h].id)}else{console.log("Dropped message: "+f[h])}}}}}}}setTimeout(function(){e.poll()},0)}},function(){e.timeout()})}else{console.log("poll - Not connected, discontinuing.")}}};multiplayer.makeRequest=function(a,h,f,c,e,d){var g=false;var b=false;if(!d){d=30000}if(!c){c="GET"}if(!e){e=null}if(window.XMLHttpRequest){g=new XMLHttpRequest()}else{if(window.ActiveXObject){g=new ActiveXObject("Microsoft.XMLHTTP")}}g.onreadystatechange=function(){if(typeof g!="undefined"){if(g.readyState==4){response=g.responseText;if(response!=""){if(h){h(response,g)}}b=true}}else{g=false;b=true}};if(isIE){a+=((a.indexOf("?")==-1?"?":"&")+"uniq="+Math.random())}g.open(c,a,true);if(c=="POST"){g.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}if(e){g.send(""+e)}else{g.send()}setTimeout(function(){if(g.readyState!=4){if(caller.network_timeout){caller.network_timeout(g,this)}g=false;b=true}},d)};